{% extends "scentpick/base.html" %}
{% block title %}ScentPick Chat{% endblock %}
{% block content %}
<div class="chat-container">
  <div class="chat-sidebar">
    <button class="new-chat-btn" id="newChatBtn">ìƒˆ ì±„íŒ…</button>
    <ul class="chat-history" id="chatHistory">
      {% if recent_conversations %}
        {% for conversation in recent_conversations %}
          <li class="conversation-item{% if conversation.id == current_conversation_id %} active{% endif %}" 
              data-conversation-id="{{ conversation.id }}"
              onclick="loadConversation({{ conversation.id }})">
            {{ conversation.title|default:"ëŒ€í™”"|truncatechars:25 }}
          </li>
        {% endfor %}
      {% else %}
        <li class="no-conversations">ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
      {% endif %}
    </ul>
  </div>

  <div class="chat-main">
    <div class="chat-header">
      <h3 style="margin-bottom:10px;">ScentPick AI ì±—ë´‡</h3>
      <div class="chat-examples">ğŸ’¡ ì˜ˆì‹œ: "30ëŒ€ ë‚¨ìê°€ ìì£¼ ì°¾ëŠ” í–¥ìˆ˜ ì•Œë ¤ì¤˜", "ì½”íŠ¼ í–¥ì˜ 20ë§Œì› ì´í•˜ í–¥ìˆ˜"</div>
    </div>
    <div class="chat-messages" id="chatMessages">
      {% comment %}
      <!-- ì„œë²„ ë Œë”ë§ëœ ë©”ì‹œì§€ëŠ” JavaScriptì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬ -->
      {% if chat_messages %}
        <!-- JavaScriptì—ì„œ ì²˜ë¦¬ë¨ -->
      {% else %}
        <div class="message">
          <div class="message-content">ì•ˆë…•í•˜ì„¸ìš”! ScentPick AIì…ë‹ˆë‹¤. ì–´ë–¤ í–¥ìˆ˜ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?</div>
        </div>
      {% endif %}
      {% endcomment %}
    </div>
    <div class="chat-input">
      <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="chatInput" autocomplete="off">
      <button class="send-btn" id="chatSendBtn">ì „ì†¡</button>
    </div>
  </div>

</div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked@13.0.3/marked.min.js"></script>
<script>
  // marked.js ë¡œë“œ í™•ì¸
  window.addEventListener('load', function() {
    console.log('marked ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒíƒœ:', typeof marked !== 'undefined' ? 'ë¡œë“œë¨' : 'ë¡œë“œ ì‹¤íŒ¨');
    if (typeof marked !== 'undefined') {
      console.log('marked ë²„ì „:', marked.getDefaults ? 'v4+' : 'v3 ì´í•˜');
    }
  });

  // CSRF í† í°
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const CSRF_TOKEN = getCookie('csrftoken');
  
  // ì´ˆê¸° ë©”ì‹œì§€ ë°ì´í„° (ì„œë²„ì—ì„œ ì „ë‹¬)
  let INITIAL_MESSAGES = [];
  try {
    const messagesData = '{{ chat_messages|escapejs }}';
    if (messagesData && messagesData !== '[]' && messagesData !== '') {
      INITIAL_MESSAGES = JSON.parse(messagesData);
      console.log('ì´ˆê¸° ë©”ì‹œì§€ íŒŒì‹± ì„±ê³µ:', INITIAL_MESSAGES.length, 'ê°œ');
    } else {
      console.log('ì´ˆê¸° ë©”ì‹œì§€ ë°ì´í„° ì—†ìŒ');
      INITIAL_MESSAGES = [];
    }
  } catch (e) {
    console.error('ì´ˆê¸° ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
    console.error('íŒŒì‹± ì‹œë„í•œ ë°ì´í„°:', '{{ chat_messages|escapejs }}');
    INITIAL_MESSAGES = [];
  }

  (function () {
    const sendBtn = document.getElementById("chatSendBtn");
    const input   = document.getElementById("chatInput");
    const box     = document.getElementById("chatMessages");
    const newBtn  = document.getElementById("newChatBtn");
    const historyList = document.getElementById("chatHistory");
    
    if (!sendBtn || !input || !box || !historyList) return;

    // ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ì´ˆê¸° ì»¨í…ìŠ¤íŠ¸(ì—†ì„ ìˆ˜ ìˆìŒ)
    let conversationId   = {{ conversation_id|default:"null" }};
    let externalThreadId = {% if external_thread_id %}"{{ external_thread_id }}"{% else %}null{% endif %};

    // ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadConversations() {
      try {
        const resp = await fetch("{% url 'scentpick:conversations_api' %}", {
          method: "GET",
          headers: {
            "X-CSRFToken": CSRF_TOKEN
          }
        });
        
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        
        const data = await resp.json();
        historyList.innerHTML = '';
        
        if (data.items && data.items.length > 0) {
          data.items.forEach(conv => {
            const li = document.createElement("li");
            li.className = "conversation-item";
            li.dataset.conversationId = conv.id;
            li.textContent = conv.title || `ëŒ€í™” ${conv.id}`;
            li.addEventListener('click', () => window.loadConversation(conv.id));
            historyList.appendChild(li);
          });
        } else {
          const li = document.createElement("li");
          li.className = "no-conversations";
          li.textContent = "ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.";
          historyList.appendChild(li);
        }
      } catch (e) {
        console.error('ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        // ì¡°ìš©íˆ ì‹¤íŒ¨ ì²˜ë¦¬ - í† ìŠ¤íŠ¸ ì•Œë¦¼ ì—†ìŒ
        if (historyList) {
          historyList.innerHTML = '<li class="error">ëŒ€í™” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>';
        }
      }
    }

    // íŠ¹ì • ëŒ€í™”ì˜ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° (ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ)
    window.loadConversation = async function(convId) {
      try {
        // í™œì„± ëŒ€í™” í‘œì‹œ
        document.querySelectorAll('.conversation-item').forEach(item => {
          item.classList.remove('active');
        });
        document.querySelector(`[data-conversation-id="${convId}"]`).classList.add('active');
        
        const resp = await fetch(`/api/conversations/${convId}/messages`, {
          method: "GET",
          headers: {
            "X-CSRFToken": CSRF_TOKEN
          }
        });
        
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        
        const data = await resp.json();
        conversationId = data.conversation_id;
        
        // ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ ì´ˆê¸°í™”
        box.innerHTML = '';
        
        if (data.items && data.items.length > 0) {
          data.items.forEach(msg => {
            const messageElement = addMessage(msg.content, msg.role === 'user');
            
            // assistant ë©”ì‹œì§€ì— ì¶”ì²œ ë²„íŠ¼ì´ ìˆìœ¼ë©´ ë³µì›
            if (msg.role === 'assistant' && msg.perfume_list && msg.perfume_list.length > 0) {
              addPerfumeRecommendations(messageElement.wrap, msg.perfume_list);
            }
          });
        } else {
          addMessage("ì´ ëŒ€í™”ì—ëŠ” ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.", false, false);
        }
        
      } catch (e) {
        console.error('ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        // ì¡°ìš©íˆ ì‹¤íŒ¨ ì²˜ë¦¬ - ì‹¬ê°í•œ ì˜¤ë¥˜ë§Œ í‘œì‹œ
        if (e.message && !e.message.includes('404')) {
          addMessage(`ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, false, false);
        }
      }
    }

    // ìƒˆ ì±„íŒ… ì‹œì‘
    async function startNewChat() {
      try {
        const resp = await fetch("{% url 'scentpick:chat_new_api' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF_TOKEN
          }
        });
        
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        
        const data = await resp.json();
        
        // ìƒíƒœ ì´ˆê¸°í™”
        conversationId = null;
        externalThreadId = data.external_thread_id;
        
        // UI ì´ˆê¸°í™”
        box.innerHTML = "";
        addMessage("ì•ˆë…•í•˜ì„¸ìš”! ScentPick AIì…ë‹ˆë‹¤. ì–´ë–¤ í–¥ìˆ˜ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?", false, false);
        
        // í™œì„± ëŒ€í™” í‘œì‹œ í•´ì œ
        document.querySelectorAll('.conversation-item').forEach(item => {
          item.classList.remove('active');
        });
        
        input.focus();
        
      } catch (e) {
        console.error('ìƒˆ ì±„íŒ… ì‹œì‘ ì‹¤íŒ¨:', e);
        // ì¡°ìš©íˆ ì‹¤íŒ¨ ì²˜ë¦¬
        addMessage(`ìƒˆ ì±„íŒ…ì„ ì‹œì‘í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, false, false);
      }
    }

    // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ í•¨ìˆ˜
    function renderMarkdown(text) {
      try {
        console.log('ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ì‹œë„:', text);
        
        // markedê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (typeof marked === 'undefined') {
          console.error('marked ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
          return text;
        }
        
        // marked ì„¤ì •
        marked.setOptions({
          breaks: true,
          gfm: true,
          headerIds: false,
          mangle: false
        });
        
        // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
        const htmlContent = marked.parse(text);
        console.log('ë³€í™˜ëœ HTML:', htmlContent);
        return htmlContent;
        
      } catch (e) {
        console.error('ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì˜¤ë¥˜:', e);
        return text; // ì˜¤ë¥˜ ì‹œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ fallback
      }
    }

    function addMessage(msg, isUser = false, useMarkdown = true) {
      const wrap  = document.createElement("div");
      wrap.className = "message" + (isUser ? " user" : "");
      const inner = document.createElement("div");
      inner.className = "message-content";
      
      if (isUser || !useMarkdown) {
        // ì‚¬ìš©ì ë©”ì‹œì§€ ë˜ëŠ” ë§ˆí¬ë‹¤ìš´ ë¹„í™œì„±í™” ì‹œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
        inner.textContent = msg;
      } else {
        // AI ë©”ì‹œì§€ëŠ” ë§ˆí¬ë‹¤ìš´ ë Œë”ë§
        inner.innerHTML = renderMarkdown(msg);
      }
      
      wrap.appendChild(inner);
      box.appendChild(wrap);
      box.scrollTop = box.scrollHeight;
      return { wrap, inner };
    }

    // ì¶”ì²œ í–¥ìˆ˜ ë²„íŠ¼ë“¤ì„ ë©”ì‹œì§€ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function addPerfumeRecommendations(messageWrap, perfumes) {
      if (!perfumes || perfumes.length === 0) return;
      
      const recommendationsDiv = document.createElement("div");
      recommendationsDiv.className = "perfume-recommendations";
      
      perfumes.slice(0, 5).forEach(perfume => {
        const button = document.createElement("button");
        button.className = "perfume-btn";
        button.textContent = `${perfume.brand} - ${perfume.name}`;
        button.onclick = () => {
          window.location.href = `/perfume/${perfume.id}/`;
        };
        recommendationsDiv.appendChild(button);
      });
      
      messageWrap.appendChild(recommendationsDiv);
      box.scrollTop = box.scrollHeight;
    }

    function addLoading() {
      return addMessage("ìƒê° ì¤‘...", false, false); // ë§ˆí¬ë‹¤ìš´ ë¹„í™œì„±í™”
    }

    async function send() {
      const txt = (input.value || "").trim();
      if (!txt) return;

      // UI ë¨¼ì € ë°˜ì‘
      input.value = "";
      addMessage(txt, true);
      sendBtn.disabled = true;
      input.disabled = true;
      const loader = addLoading();

      try {
        const resp = await fetch("{% url 'scentpick:chat_submit_api' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF_TOKEN
          },
          body: JSON.stringify({
            content: txt,
            conversation_id: conversationId || null
          })
        });

        if (!resp.ok) {
          let errText = `HTTP ${resp.status}`;
          try {
            const j = await resp.json();
            if (j && j.error) errText = j.error;
          } catch (_e) {}
          loader.inner.innerHTML = renderMarkdown(`ì˜¤ë¥˜: ${errText}`);
          return;
        }

        const data = await resp.json();

        // ìµœì‹  ìƒíƒœ ë°˜ì˜
        conversationId   = data.conversation_id;
        externalThreadId = data.external_thread_id;

        // ìµœì¢… ë‹µë³€ìœ¼ë¡œ êµì²´ (ë§ˆí¬ë‹¤ìš´ ë Œë”ë§)
        const finalAnswer = data.final_answer || "(ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤)";
        loader.inner.innerHTML = renderMarkdown(finalAnswer);
        
        // ì¶”ì²œ í–¥ìˆ˜ ë¦¬ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ ë²„íŠ¼ë“¤ ì¶”ê°€
        if (data.perfume_list && data.perfume_list.length > 0) {
          addPerfumeRecommendations(loader.wrap, data.perfume_list);
        }
        
        // ëŒ€í™” ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ìƒˆ ëŒ€í™”ê°€ ìƒì„±ë˜ì—ˆì„ ìˆ˜ ìˆìŒ)
        loadConversations();

      } catch (e) {
        loader.inner.innerHTML = renderMarkdown(`ì˜¤ë¥˜: ${e && e.message ? e.message : e}`);
      } finally {
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    sendBtn.addEventListener("click", send);
    input.addEventListener("keypress", (e) => { if (e.key === "Enter") send(); });
    newBtn.addEventListener("click", startNewChat);

    // í˜„ì¬ ëŒ€í™” ID ì„¤ì • (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ê°’)
    {% if current_conversation_id %}
      conversationId = {{ current_conversation_id }};
    {% endif %}
    
    // ì´ˆê¸° ë©”ì‹œì§€ ì²˜ë¦¬ ë° ì¶”ì²œ ë²„íŠ¼ ë³µì› (ì•ˆì „í•œ ì²˜ë¦¬)
    try {
      if (INITIAL_MESSAGES && Array.isArray(INITIAL_MESSAGES) && INITIAL_MESSAGES.length > 0) {
        console.log('ì´ˆê¸° ë©”ì‹œì§€ ë³µì› ì‹œì‘:', INITIAL_MESSAGES.length, 'ê°œ');
        
        // ê¸°ì¡´ ì„œë²„ ë Œë”ë§ ë©”ì‹œì§€ ì œê±°í•˜ê³  JavaScriptë¡œ ë‹¤ì‹œ ë Œë”ë§
        if (box) {
          box.innerHTML = '';
          
          INITIAL_MESSAGES.forEach((msg, index) => {
            try {
              if (msg && typeof msg === 'object' && msg.content) {
                const messageElement = addMessage(msg.content, msg.role === 'user');
                
                // assistant ë©”ì‹œì§€ì— ì¶”ì²œ ë²„íŠ¼ì´ ìˆìœ¼ë©´ ë³µì›
                if (msg.role === 'assistant' && msg.perfume_list && Array.isArray(msg.perfume_list) && msg.perfume_list.length > 0) {
                  console.log(`ë©”ì‹œì§€ ${index}: ì¶”ì²œ ë²„íŠ¼ ${msg.perfume_list.length}ê°œ ë³µì›`);
                  try {
                    addPerfumeRecommendations(messageElement.wrap, msg.perfume_list);
                  } catch (perfumeError) {
                    console.warn(`ì¶”ì²œ ë²„íŠ¼ ë³µì› ì‹¤íŒ¨ (ë©”ì‹œì§€ ${index}):`, perfumeError);
                  }
                }
              }
            } catch (msgError) {
              console.warn(`ë©”ì‹œì§€ ${index} ì²˜ë¦¬ ê±´ë„ˆë›°ê¸°:`, msgError);
            }
          });
          
          console.log('ì´ˆê¸° ë©”ì‹œì§€ ë³µì› ì™„ë£Œ');
        }
      } else {
        console.log('ì´ˆê¸° ë©”ì‹œì§€ ì—†ìŒ - ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ');
        if (box) {
          box.innerHTML = '';
          addMessage("ì•ˆë…•í•˜ì„¸ìš”! ScentPick AIì…ë‹ˆë‹¤. ì–´ë–¤ í–¥ìˆ˜ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?", false, false);
        }
      }
    } catch (e) {
      console.warn('ì´ˆê¸° ë©”ì‹œì§€ ë³µì› ì¤‘ ì˜¤ë¥˜ ë°œìƒ - ê¸°ë³¸ ìƒíƒœ ìœ ì§€:', e);
    }
    
    // ì´ˆê¸° ëŒ€í™” ëª©ë¡ì€ ì„œë²„ì—ì„œ ì´ë¯¸ ë Œë”ë§ë¨
    // í•„ìš”ì‹œì—ë§Œ AJAXë¡œ ìƒˆë¡œê³ ì¹¨
  })();
</script>
{% endblock %}
